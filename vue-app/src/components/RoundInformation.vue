<template>
  <div class="projects">
    <div class="round-info">
      <div class="image-wrapper">
        <image-responsive title="hero" height="80%" />
      </div>
      <template v-if="roundInfo">
        <div class="round">
          <div class="round-title-bar">
            <h2 class="round-title">{{ $store.getters.operator }}</h2>
            <v-popover class="verified-container">
              <div class="verified">
                <img src="@/assets/verified.svg" />
              </div>
              <template slot="popover">
                <div class="contract-popover">
                  <div class="contract-address">
                    {{ roundInfo.fundingRoundAddress }}
                  </div>
                  <links :to="blockExplorer.url"
                    >View on {{ blockExplorer.label }}</links
                  >
                </div>
              </template>
            </v-popover>
          </div>
          <div class="status" v-if="isRoundCancelled">
            <div class="circle closed" />
            Cancelled
          </div>
          <div
            class="status"
            v-else-if="
              isCurrentRound &&
              !$store.getters.isRoundFinalized &&
              !$store.getters.isRoundTallying
            "
          >
            <div class="circle open-pulse" />
            Open
          </div>
          <div v-else class="status">
            <div class="circle closed" />
            Closed
          </div>
        </div>
        <template v-if="isCurrentRound">
          <div v-if="isMaxMessagesReached" class="round-notice hidden">
            <span class="bold-all-caps">
              <p>The round is officially closed</p>
            </span>
            <p>
              It's now too late to contribute or reallocate your donations! Due
              to the community's generosity and some technical constraints we
              had to close the round earlier than expected. You can still help
              by donating to the matching pool.
            </p>
            <div class="dismiss-btn" @click="toggleNotice">Great!</div>
          </div>
          <div class="round-info-item" v-if="isRoundJoinOnlyPhase">
            <div class="full-width">
              <div class="round-info-item-top">
                <div class="round-info-title">‚è±Ô∏è Round opening</div>
              </div>
            </div>
            <div class="round-info-value">
              <time-left :date="$store.getters.recipientJoinDeadline" />
            </div>
          </div>
          <div
            v-else-if="
              $store.getters.isRoundContributionPhase &&
              !$store.getters.hasUserContributed
            "
            class="round-info-item"
          >
            <div class="full-width">
              <div class="round-info-item-top">
                <div class="round-info-title">Time left to donate</div>
              </div>
            </div>
            <div
              class="round-info-value"
              :title="
                'Contribution Deadline: ' + formatDate(roundInfo.signUpDeadline)
              "
            >
              <time-left :date="roundInfo.signUpDeadline" />
            </div>
          </div>
          <div
            v-else-if="
              $store.getters.isRoundReallocationPhase ||
              $store.getters.canUserReallocate
            "
            class="round-info-item"
          >
            <div class="full-width">
              <div class="round-info-item-top">
                <div class="round-info-title">
                  {{
                    $store.getters.hasUserContributed
                      ? 'Time left to reallocate'
                      : 'Round status'
                  }}
                </div>
                <img
                  v-if="$store.getters.hasUserContributed"
                  v-tooltip="{
                    content: `During this phase, you can add/remove projects and change your contribution amounts. You can't make a contribution or increase your overall total.`,
                    trigger: 'hover click',
                  }"
                  width="16px"
                  src="@/assets/info.svg"
                />
                <img
                  v-else-if="!$store.state.currentUser"
                  v-tooltip="{
                    content: `If you've contributed, you can add/remove projects and change your contribution amounts. Please connect your wallet.`,
                    trigger: 'hover click',
                  }"
                  width="16px"
                  src="@/assets/info.svg"
                />
                <img
                  v-else
                  v-tooltip="{
                    content: `This round has closed for new contributions.`,
                    trigger: 'hover click',
                  }"
                  width="16px"
                  src="@/assets/info.svg"
                />
              </div>
              <div class="message" v-if="!$store.getters.hasUserContributed">
                Closed for contributions
              </div>
              <div
                v-else
                class="round-info-value"
                :title="
                  'Reallocation Deadline: ' +
                  formatDate(roundInfo.votingDeadline)
                "
              >
                <div class="round-info-value">
                  <time-left :date="roundInfo.votingDeadline" />
                </div>
              </div>
            </div>
          </div>
          <div
            v-else-if="$store.getters.isRoundTallying"
            class="round-info-item"
          >
            <div class="full-width">
              <div class="round-info-item-top">
                <div class="round-info-title">Round status</div>
                <img
                  v-tooltip="{
                    content: `Our smart contracts are busy figuring out final contribution amounts.`,
                    trigger: 'hover click',
                  }"
                  width="16px"
                  src="@/assets/info.svg"
                />
              </div>
              <div class="round-info-value">
                <div class="message">Tallying all contributions</div>
              </div>
            </div>
          </div>
          <div
            v-else-if="$store.getters.isRoundFinalized"
            class="round-info-item"
          >
            <div class="full-width">
              <div class="round-info-item-top">
                <div class="round-info-title">Round status</div>
                <img
                  v-tooltip="{
                    content: `If you're a project owner you can now claim your funds!`,
                    trigger: 'hover click',
                  }"
                  width="16px"
                  src="@/assets/info.svg"
                />
              </div>
              <div class="round-info-value">
                <div class="message">Contributions are ready to claim üéâ</div>
              </div>
            </div>
          </div>
        </template>
        <div class="round-value-info">
          <div class="round-value-info-item">
            <div class="full-width">
              <div class="round-info-item-top">
                <div class="round-info-title">Total in round</div>
                <img
                  v-tooltip="{
                    content: `This total includes the funds in the matching pool and all contributions from the community.`,
                    trigger: 'hover click',
                  }"
                  width="16px"
                  src="@/assets/info.svg"
                />
              </div>
              <div class="round-info-value">
                <h2>
                  {{ formatTotalInRound }}
                  <h4>{{ roundInfo.nativeTokenSymbol }}</h4>
                </h2>
              </div>
            </div>
          </div>
          <div class="round-info-sub-item">
            <div class="round-info-item-top">
              <div class="round-info-title">Matching pool</div>
              <img
                v-tooltip="{
                  content:
                    'These are the funds that will be distributed to all the projects based on the contributions they receive from the community.',
                  trigger: 'hover click',
                }"
                width="16px"
                src="@/assets/info.svg"
              />
              <div
                v-if="
                  isCurrentRound &&
                  !$store.getters.isRoundFinalized &&
                  !$store.getters.isRoundTallying &&
                  !isRoundCancelled
                "
                v-tooltip="'Add matching funds'"
                class="add-link"
                @click="addMatchingFunds"
              >
                <a class="text-link" id="link-position">Add Funds</a>
              </div>
            </div>

            <div class="round-info-value">
              <h2>
                {{ formatAmount(roundInfo.matchingPool) }}
                <h4>{{ roundInfo.nativeTokenSymbol }}</h4>
              </h2>
            </div>
          </div>
          <div class="round-info-sub-item">
            <div>
              <div class="round-info-title">Contributions total</div>
              <div class="round-info-value">
                <h2>
                  {{ formatAmount(roundInfo.contributions) }}
                  <h4>{{ roundInfo.nativeTokenSymbol }}</h4>
                </h2>
              </div>
            </div>
          </div>
          <div class="round-info-sub-item">
            <div>
              <div class="round-info-title">Contributors</div>
              <div class="round-info-value">
                <h2>
                  {{ roundInfo.contributors }}
                  <h4>Legend{{ roundInfo.contributors !== 1 ? 's' : '' }}</h4>
                </h2>
              </div>
            </div>
          </div>
        </div>
      </template>
      <template v-else-if="!roundInfo && !isLoading">
        <div class="round-info-item">
          <div class="full-width">
            <div class="round-info-item-top">
              <div class="round-info-title">No scheduled round</div>
            </div>
          </div>
          <div class="round-announcement-info">
            We haven't yet scheduled a funding round. Stay tuned!
          </div>
        </div>
      </template>
      <loader v-if="isLoading" />
    </div>
  </div>
</template>

<script lang="ts">
import Vue from 'vue'
import { Watch } from 'vue-property-decorator'
import Component from 'vue-class-component'
import { BigNumber, FixedNumber } from 'ethers'
import { DateTime } from 'luxon'

import { RoundInfo, getRoundInfo } from '@/api/round'
import { chain } from '@/api/core'

import { lsGet, lsSet } from '@/utils/localStorage'
import { formatAmount } from '@/utils/amounts'
import ProjectListItem from '@/components/ProjectListItem.vue'
import MatchingFundsModal from '@/components/MatchingFundsModal.vue'
import Loader from '@/components/Loader.vue'
import WalletModal from '@/components/WalletModal.vue'
import TimeLeft from '@/components/TimeLeft.vue'
import Links from '@/components/Links.vue'
import ImageResponsive from '@/components/ImageResponsive.vue'
import { LOAD_ROUND_INFO } from '@/store/action-types'

@Component({
  components: {
    ProjectListItem,
    Loader,
    WalletModal,
    TimeLeft,
    Links,
    ImageResponsive,
  },
})
export default class RoundInformation extends Vue {
  isLoading = true
  roundInfo: RoundInfo | null = null

  async created() {
    await this.loadRoundInfo()

    // Message cap notice defaults with `hidden` class
    // If it hasn't been dismissed yet, this class is toggled off until dismissed
    const showNotice = !lsGet(this.lsIsNoticeHiddenKey, false)
    if (showNotice) {
      this.toggleNotice()
    }
  }

  get isRoundCancelled(): boolean {
    return this.$store.getters.isRoundCancelled(this.roundInfo)
  }

  get isMaxMessagesReached(): boolean {
    if (!this.roundInfo) {
      return true
    }

    return this.roundInfo.maxMessages <= this.roundInfo.messages
  }

  // Gets local storage key to look up if user has dismissed round notice (if message cap exceeded)
  // Key specific to each round via round address
  get lsIsNoticeHiddenKey(): string {
    return `${this.roundInfo?.fundingRoundAddress}.is-notice-hidden`
  }

  get roundAddress(): string | null {
    return this.$route.params?.address || this.$store.state.currentRoundAddress
  }

  @Watch('roundAddress')
  async loadRoundInfo() {
    this.roundInfo = null
    this.isLoading = true
    if (this.roundAddress) {
      this.roundInfo = await getRoundInfo(
        this.roundAddress,
        this.$store.state.currentRound
      )
    }
    this.isLoading = false
  }

  toggleNotice() {
    const elements = document.getElementsByClassName('round-notice')
    for (let i = 0; i < elements.length; i++) {
      elements[i].classList.toggle('hidden')
    }
    lsSet(this.lsIsNoticeHiddenKey, !lsGet(this.lsIsNoticeHiddenKey))
  }

  get formatTotalInRound(): string {
    if (!this.roundInfo) {
      return ''
    }

    const { contributions, matchingPool } = this.roundInfo
    const totalInRound = contributions.addUnsafe(matchingPool)

    return this.formatAmount(totalInRound)
  }

  get isCurrentRound(): boolean {
    const roundAddress = this.roundInfo?.fundingRoundAddress || ''
    return this.$store.getters.isCurrentRound(roundAddress)
  }

  get isRoundJoinOnlyPhase(): boolean {
    return this.isCurrentRound && this.$store.getters.isRoundJoinOnlyPhase
  }

  formatIntegerPart(value: FixedNumber): string {
    if (value._value === '0.0') {
      return '0'
    }
    const integerPart = value.toString().split('.')[0]
    return integerPart + (value.round(0) === value ? '' : '.')
  }

  formatFractionalPart(value: FixedNumber): string {
    return value._value === '0.0' ? '' : value.toString().split('.')[1]
  }

  formatDate(value: DateTime): string {
    return value.toLocaleString(DateTime.DATETIME_SHORT) || ''
  }

  formatAmount(value: BigNumber | FixedNumber | string): string {
    return formatAmount(value, this.roundInfo?.nativeTokenDecimals, 4)
  }

  addMatchingFunds(): void {
    if (!this.$store.state.currentUser) {
      return this.$modal.show(
        WalletModal,
        {},
        { width: 400, top: 20 },
        {
          // If closed but no user was connected in the event, then this will be closing the WalletModal
          // and dont do anythign else. If closed and a user was connected, call the addMatchingFunds method
          // again to pop open the MatchingFundsModal after the WalletModal.
          closed: () => {
            if (this.$store.state.currentUser) {
              this.addMatchingFunds()
            }
          },
        }
      )
    }

    return this.$modal.show(
      MatchingFundsModal,
      {},
      {},
      {
        closed: () => {
          // Reload matching pool size
          this.$store.dispatch(LOAD_ROUND_INFO)
        },
      }
    )
  }

  get blockExplorer(): { label: string; url: string } {
    return {
      label: chain.explorerLabel,
      url: `${chain.explorer}/address/${this.roundInfo?.fundingRoundAddress}`,
    }
  }
}
</script>

<style scoped lang="scss">
@import '../styles/vars';
@import '../styles/theme';

.image-wrapper {
  border-radius: 8px;
  background: $clr-purple;
  height: 200px;
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.image-wrapper img {
  mix-blend-mode: luminosity;
}

.round {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.round-title-bar {
  display: flex;
  align-items: center;
}
.round-title {
  line-height: 120%;
  margin: 0;
}

.verified-container {
  align-self: flex-end;
}

.verified {
  img {
    filter: var(--img-filter, invert(0.3));
  }
}

.contract-address {
  text-overflow: ellipsis;
  overflow: hidden;
  width: 100%;
  margin-bottom: 0.5rem;
}

.circle {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 0.5rem;
}

.closed {
  width: 12px;
  height: 12px;
  background: var(--bg-light-color);
}

.open-pulse {
  animation: pulse-animation 2s infinite ease-out;
  background: $clr-green;
}

@keyframes pulse-animation {
  0% {
    box-shadow: 0 0 0 0px $idle-color;
  }

  50% {
    box-shadow: 0 0 0 2.5px $clr-green;
  }

  100% {
    box-shadow: 0 0 0 5px $clr-pink;
  }
}

.projects {
  display: flex;
  justify-content: center;
}

.round-info {
  display: flex;
  flex-wrap: wrap;
  align-items: flex-start;
  gap: 1.5rem;
  margin-top: 1rem;
  max-width: 800px;
  @media (max-width: $breakpoint-m) {
    padding: 1rem;
    padding-bottom: 4rem;
  }
}

.round-value-info {
  width: 100%;
  display: grid;
  align-items: center;
  margin-bottom: 3rem;
  border-radius: 0.5rem;

  img {
    opacity: 0.6;
  }

  & > div {
    box-shadow: inset 0px -1px 0px #7375a6;
    &:first-of-type {
      border-radius: 0.5rem 0.5rem 0 0;
    }
    &:last-of-type {
      border-radius: 0 0 0.5rem 0.5rem;
      box-shadow: none;
    }
  }
}

.round-value-info-item {
  display: flex;
  flex: 1 0 auto;
  justify-content: space-between;
  align-items: center;
  background: var(--bg-round-info-body);
  padding: 1rem;
}

.round-info-item {
  display: flex;
  flex-direction: column;
  flex: 1 0 auto;
  justify-content: space-between;
  align-items: flex-start;
  background: var(--bg-round-info-header);
  border: 2px solid $clr-dark;
  padding: 1rem;
  border-radius: 0.5rem;
  box-sizing: border-box;
  width: 100%;

  img {
    opacity: 0.6;
  }
}

.round-info-item-top {
  width: 100%;
  display: flex;
  gap: 0.5rem;
  align-items: flex-start;
}

.round-info-sub-item {
  flex: 1 0 10%;
  background: var(--bg-round-info-body);
  padding: 1rem;

  img {
    opacity: 0.6;
  }
}

.round-info-title {
  color: var(--text-color);
  font-size: 14px;
  font-weight: 400;
  line-height: 120%;
  text-transform: uppercase;
  white-space: nowrap;
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.5rem;
}

.round-info-value {
  h2 {
    margin: 0;
  }

  h4 {
    margin: 0;
    display: inline;
  }
}

.round-announcement-info {
  .value {
    font-size: 24px;
    font-family: 'Glacial Indifference', sans-serif;
    color: white;
    font-weight: 700;
    line-height: 120%;

    &.large {
      font-size: 32px;
      line-height: 120%;
    }

    &.extra {
      font-size: 32px;
      font-family: 'Glacial Indifference', sans-serif;
      color: white;
      line-height: 120%;
    }
  }

  .unit {
    color: white;
    font-family: 'Glacial Indifference', sans-serif;
    font-size: 16px;
    font-weight: 600;
    text-transform: uppercase;
    line-height: 150%;
    margin: 0 0.5rem;

    &:last-child {
      margin-right: 0;
    }
  }
}

.message {
  color: var(--text-color);
  font-family: 'Glacial Indifference', sans-serif;
  font-size: 16px;
  font-weight: 600;
  text-transform: uppercase;
  line-height: 150%;
}

.add-matching-funds-btn {
  display: inline-block;
  margin-left: 5px;

  img {
    height: 1.8em;
    vertical-align: middle;
  }
}

.project-list {
  box-sizing: border-box;
  margin: 100%;

  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: $content-space;
}

/* @media (max-width: 1500px) {
  .round-info-item:nth-child(2n) {
    break-after: always;
  }

  .round-info-title {
    margin-bottom: $content-space / 2;
    font-size: 14px;
  }
} */

.add-link {
  position: relative;
  display: flex;
  gap: 0.25rem;
  margin-left: auto;
  cursor: pointer;
  &:hover {
    opacity: 0.8;
  }
}

#link-position {
  position: relative;
  width: max-content;
  right: 20px;
  top: 26px;
}

.status {
  font-size: 16px;
  display: flex;
  align-items: center;
}

.full-width {
  width: 100%;
}

.round-notice {
  background: var(--warning-background);
  border: 1px solid var(--warning-border);
  border-radius: 0.5rem;
  padding: 0.5rem 1rem 1rem;
  color: var(--warning-color);
  font-size: 14px;
  line-height: 150%;
  font-weight: 500;
  .bold-all-caps {
    text-transform: uppercase;
    font-weight: 600;
  }
  .dismiss-btn {
    @include button(var(--warning-color), none, 1px solid var(--warning-color));
    margin: 0 auto;
    width: fit-content;
    padding: 0.25rem 1.25rem;
  }
}

.hidden {
  display: none;
}

.has-tooltip {
  filter: var(--img-filter, invert(0.7));
}
</style>
